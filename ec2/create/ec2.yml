# Basic provisioning example
#- local_action:
#    module: ec2
#    key_name: mykey
#    instance_type: c1.medium
#    image: emi-40603AD1
#    wait: yes
#    group: webserver
#    count: 3


- name: Create a sandbox instance
  hosts: localhost
  gather_facts: False
  vars:
    key_name: mbro
    instance_type: m1.small
    security_group_id: sg-33f9ff56
    image: ami-22ed474a
    region: us-east-1
  tasks:
    - name: Launch instance
      local_action: ec2 key_name={{ key_name }} group_id={{ security_group_id }} instance_type={{ instance_type }} image={{ image }} wait=yes region={{ region }} count=2
      register: ec2

    - name: Add new instance to host group
      local_action: add_host hostname={{ item.public_ip }} groupname=mbro-grp1
      with_items: ec2.instances

    - name: Wait for SSH to come up
      local_action: wait_for host={{ item.public_dns_name }} port=22 delay=5 timeout=320 state=started
      with_items: ec2.instances    

    - name: Terminate instances that were previously launched
      local_action:
        module: ec2
        state: 'absent'
        region: us-east-1
        instance_ids: '{{ ec2.instance_ids }}'
